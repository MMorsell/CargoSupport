@model List<CargoSupport.Models.DatabaseModels.DataModel>;
@{
    ViewData["Title"] = "Föraranalys";
}

<div class="container-flow">
    <div class="row">
        <div class="col-4">
            <h6>Visa data</h6>
            <div>
                <div style="padding-left: 20px;" class="group">
                    <label class="input-label">Från</label>
                    <input type="text" id="calendar-from-group-dashboard">
                    <span class="bar"></span>
                </div>
                <div style="padding-left: 30px;" class="group">
                    <label class="input-label">Till</label>
                    <input type="text" id="calendar-to-group-dashboard">
                    <span class="bar"></span>
                </div>
            </div>
        </div>
        <div class="col-4">
            <button onclick="resetTable()">Återgå till gruppvy</button>
        </div>
        <div class="col-4">
        </div>
    </div>
    <div class="row ">
        <table id="dataTable" class="table table-striped table-bordered" style="width:100%; white-space: nowrap;">
            <thead style="position: sticky; top: 0;">
            </thead>
        </table>
    </div>
</div>

@section Scripts
{
    <script>
        const mainApiEndpoint = driverExtendedStats;
        fromDate = moment().subtract(7, 'd');
        toDate = moment();
        let section = null;
        let staffCat = null;

        function resetTable() {
            staffCat = null;
            section = null;
            table.ajax.reload(null, false);
        }

        function redrawTableById(sectionId, staffCatId) {
            if (sectionId != null) {
                section = sectionId;
            }

            if (staffCatId != null) {
                staffCat = staffCatId;
            }

            table.ajax.reload(null, false);
        }
        const boss_extendedInfo = function (data, type, full, meta) {
            if (type === 'sort' || type === 'filter') {
                return data;
            }
            return '<a class="nav-link text-dark" onClick="redrawTableById(' + full.sectionId + ',' + full.staffCatId + ')">' + data + '</a>';
        }

        $(document).ready(function () {
            table = $('#dataTable').DataTable({
                pageLength: 250,
                "ajax": {
                    "url": mainApiEndpoint,
                    "data": {
                        "fromDate": function () { return fromDate.format(timeFormat) },
                        "toDate": function () { return toDate.format(timeFormat) },
                        "sectionId": function () { return section },
                        "staffCatId": function () { return staffCat }
                    },
                    "dataSrc": "",
                    "complete": function (responseReference, responseText) {
                        debugger;
                    },
                    "error": function (responseReference, responseText) {
                    },
                },
                columnDefs: [
                    { "width": "20%", "targets": 3 }
                ],
                columns: [
                    { data: 'sectionId', title: 'SectionId', "visible": false, "searchable": false },
                    { data: 'staffCatId', title: 'StaffCatId', "visible": false, "searchable": false },
                    { data: 'labelTitle', title: 'Gruppnamn', render: boss_extendedInfo },
                    { data: 'numberOfValidDeliveries', title: 'Genomförda leveranser' },
                    { data: 'numberOfValidDeliveriesLeft', title: 'Leveranser ej klara' },
                    { data: 'customersWithinTimeSlot', title: 'Leveranser inom tidsfönster +-5' },
                    { data: 'customersWithinPrognosis', title: 'Leveranser inom beräknad leveranstid +-15' },
                    { data: 'customersBeforeTimeSlot', title: 'Leveranser före tidsfönster -5' },
                    { data: 'customersBeforeEstimatedTime', title: 'Leveranser före beräknad tid -15' },
                    { data: 'percentageWithing5MinOfTimeSlot', title: 'Procent Leveranser inom tidsfönster +-5' },
                    { data: 'percentageWithing15MinOfCustomerEstimatedTime', title: 'Procent Leveranser inom beräknad leveranstid +-15' },
                ]
            });

            $('thead th').each(function () {
                $(this).addClass("stickyHeader");
            })

        });
    </script>
}