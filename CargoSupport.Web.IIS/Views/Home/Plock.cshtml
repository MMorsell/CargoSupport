@model List<CargoSupport.Models.DatabaseModels.DataModel>;
@{
    ViewData["Title"] = "Home Page";
}
<div class="container-fluid">
    <h6>Datum</h6>
    <div>
        <div style="padding-left: 20px;" class="group">
            <input type="text" id="calendar-from-table">
            <span class="bar"></span>
        </div>
    </div>
    @*<div><select class="selectpicker show-tick" data-style="btn-primary"><option>Mustard</option></select></div>*@
    <table id="dataTable" class="table table-striped table-bordered" style="width:100%; white-space: nowrap;">
        <thead>
        </thead>
    </table>
</div>

@section Scripts
{
    <script>
        let table;

        let prevValues = [];

        function saveHoverVal(thisReference) {
            let tempOldVal = thisReference.options[thisReference.selectedIndex].value
            var dataRef = table.row($(thisReference).parents('tr')).data();

            var reference = prevValues.find(x => x._id === dataRef._id);

            if (reference == null) {
                prevValues.push(
                    { id: dataRef._id, oldVal: tempOldVal }
                );
            }
            else {
                reference.oldVal = tempOldVal;
            }

        }

        function proptForSignatureInt(thisReference) {
            var dataRef = table.row($(thisReference).parents('tr')).data();
            var personSignature = prompt("Signatur krävs", "");

            if (personSignature == null) {
                var reference = prevValues.find(x => x._id === dataRef._id);

                if (reference == null) {
                    thisReference.value = 99;
                }
                else {
                    thisReference.value = reference.oldVal;
                }
            }
            else if (personSignature.trim() === "") {
                alert("Tom signatur godkänns ej")
                var reference = prevValues.find(x => x._id === dataRef._id);

                if (reference == null) {
                    thisReference.value = 99;
                }
                else {
                    thisReference.value = reference.oldVal;
                }
            }
            else {
                updateRow(thisReference, personSignature);
            }
        }

        function proptForSignatureBool(thisReference) {
            var personSignature = prompt("Signatur krävs", "");

            if (personSignature == null) {
                thisReference.checked = !thisReference.checked;
            } else if (personSignature.trim() === "") {
                alert("Tom signatur godkänns ej")
                thisReference.checked = !thisReference.checked;
            }
            else {
                updateRow(thisReference, personSignature);
            }
        }

        function updateRow(thisRef, signature) {
            var dataRef = table.row($(thisRef).parents('tr')).data();
            /*
              numberOfColdBoxes: numberOfColdBoxes_input
              restPicking: restPicking_input
              numberOfFrozenBoxes: numberOfFrozenBoxes_input
              numberOfBreadBoxes: numberOfBreadBoxes_input
              controlIsDone: controlIsDone_input
             */

            var object = {
                _Id: dataRef._Id,
                numberOfColdBoxes: {},
                restPicking: {},
                numberOfFrozenBoxes: {},
                numberOfBreadBoxes: {},
                controlIsDone: {},
            };
            switch (thisRef.id) {
                case 'numberOfColdBoxes_input':
                    object.numberOfColdBoxes.Value = parseInt(thisRef.value);
                    object.numberOfColdBoxes.Signature = signature;
                    break;
                case 'restPicking_input':
                    object.restPicking.Value = thisRef.checked;
                    object.restPicking.Signature = signature;
                    break;
                case 'numberOfFrozenBoxes_input':
                    object.numberOfFrozenBoxes.Value = parseInt(thisRef.value);
                    object.numberOfFrozenBoxes.Signature = signature;
                    break;
                case 'numberOfBreadBoxes_input':
                    object.numberOfBreadBoxes.Value = parseInt(thisRef.value);
                    object.numberOfBreadBoxes.Signature = signature;
                    break;
                case 'controlIsDone_input':
                    object.controlIsDone.Value = thisRef.checked;
                    object.controlIsDone.Signature = signature;
                    break;
            }
            postUpdate(JSON.stringify(object));
        }

        function postUpdate(jsonData) {
            var dataType = 'application/json';
            console.log('Submitting form...');
            $.ajax({
                type: 'POST',
                url: baseHost + '/api/Upsert/UpsertStorage',
                //dataType: 'json',
                contentType: dataType,
                data: jsonData,
                error: function (jqXHR, exception) {
                    debugger;
                },
                success: function (result) {
                }
            });
        }

        const restPicking_input = function (data, type, full, meta) {
            var is_checked = data == true ? "checked" : "";
            return '<input id="restPicking_input" type="checkbox" onChange=proptForSignatureBool(this) class="checkbox" ' +
                is_checked + ' />';
        }

        const controlIsDone_input = function (data, type, full, meta) {
            var is_checked = data == true ? "checked" : "";
            return '<input id="controlIsDone_input" type="checkbox" onChange=proptForSignatureBool(this) class="checkbox" ' +
                is_checked + ' />';
        }

        const numberOfBreadBoxes_input = function (data, type, full, meta) {

            var selectBox = [];
            selectBox.push(
                '<div><select class="form-control" id="numberOfBreadBoxes_input" onmouseover="saveHoverVal(this)" onChange=proptForSignatureInt(this) class="dropdown bootstrap-select">'
            );

            for (i = 0; i < 100; i++) {
                if (i === data) {
                    selectBox.push('<option selected>' + i + '</option>')
                } else {
                    selectBox.push('<option>' + i + '</option>')
                }
            }
            selectBox.push(
                '</select>'
            );
            return selectBox.join("");
        }

        const numberOfFrozenBoxes_input = function (data, type, full, meta) {

            var selectBox = [];
            selectBox.push(
                '<div><select class="form-control" id="numberOfFrozenBoxes_input" onmouseover="saveHoverVal(this)" onChange=proptForSignatureInt(this) class="dropdown bootstrap-select">'
            );

            for (i = 0; i < 100; i++) {
                if (i === data) {
                    selectBox.push('<option selected>' + i + '</option>')
                } else {
                    selectBox.push('<option>' + i + '</option>')
                }
            }
            selectBox.push(
                '</select>'
            );
            return selectBox.join("");
        }

        const numberOfColdBoxes_input = function (data, type, full, meta) {

            var selectBox = [];
            selectBox.push(
                '<div><select class="form-control" id="numberOfColdBoxes_input" onmouseover="saveHoverVal(this)" onChange=proptForSignatureInt(this) class="dropdown bootstrap-select">'
            );

            for (i = 0; i < 100; i++) {
                if (i === data) {
                    selectBox.push('<option selected>' + i + '</option>')
                } else {
                    selectBox.push('<option>' + i + '</option>')
                }
            }
            selectBox.push(
                '</select>'
            );
            return selectBox.join("");
        }

        $(document).ready(function () {
            table = $('#dataTable').DataTable({
                pageLength: 250,
                "ajax": {
                    "url": baseHost + '/api/public/GetStorage',
                    "data": {
                        "dateString": function () { return formatDate(ajaxDate) }
                    },
                    "dataSrc": ""
                },
                columns: [
                    {
                        data: '_Id', title: 'ID', "visible": false,
                        "searchable": false
                    },
                    { data: 'routeName', title: 'Tur' },
                    { data: 'carNumber', title: 'Bilnr', },
                    { data: 'portNumber', title: 'Port', },
                    { data: 'loadingLevel', title: 'Lastningsstatus', render: convert_loadingLevel_toValue },
                    { data: 'numberOfCustomers', title: 'Kunder' },
                    { data: 'numberOfColdBoxes.value', title: 'Lådor', render: numberOfColdBoxes_input },
                    { data: 'restPicking.value', title: 'Restplock', render: restPicking_input },
                    { data: 'numberOfFrozenBoxes.value', title: 'Frys', render: numberOfFrozenBoxes_input },
                    { data: 'numberOfBreadBoxes.value', title: 'Bröd', render: numberOfBreadBoxes_input },
                    { data: 'controlIsDone.value', title: 'Kontroll', render: controlIsDone_input },
                ],
                "order": [[1, "asc"]],

            });
            $('thead th').each(function () {
                $(this).addClass("stickyHeader");
            })
        });
        function reloadAjax() {
            table.ajax.reload(null, false);
        }
    </script>
}